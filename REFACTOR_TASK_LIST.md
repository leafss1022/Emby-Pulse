# Stats.py é‡æ„ä»»åŠ¡åˆ—è¡¨

## ğŸ“‹ æ€»ä½“ç›®æ ‡
å°† `backend/routers/stats.py` (979è¡Œï¼Œ15ä¸ªAPIç«¯ç‚¹) æ‹†åˆ†ä¸ºå¤šä¸ªåŠŸèƒ½æ¨¡å—

## ğŸ“‚ æ‹†åˆ†æ–¹æ¡ˆ

### ç›®æ ‡æ¨¡å—ç»“æ„
```
backend/routers/
â”œâ”€â”€ stats/
â”‚   â”œâ”€â”€ __init__.py          # å¯¼å‡ºæ‰€æœ‰è·¯ç”±
â”‚   â”œâ”€â”€ overview.py          # æ€»è§ˆç»Ÿè®¡ (1ä¸ªç«¯ç‚¹)
â”‚   â”œâ”€â”€ trend.py             # è¶‹åŠ¿ç»Ÿè®¡ (2ä¸ªç«¯ç‚¹: trend + hourly)
â”‚   â”œâ”€â”€ users.py             # ç”¨æˆ·ç»Ÿè®¡ (1ä¸ªç«¯ç‚¹)
â”‚   â”œâ”€â”€ content.py           # å†…å®¹ç»Ÿè®¡ (3ä¸ªç«¯ç‚¹: clients + devices + playback-methods)
â”‚   â”œâ”€â”€ history.py           # å†å²è®°å½• (2ä¸ªç«¯ç‚¹: recent + now-playing)
â”‚   â”œâ”€â”€ favorites.py         # æ”¶è—ç»Ÿè®¡ (1ä¸ªç«¯ç‚¹)
â”‚   â”œâ”€â”€ filters.py           # ç­›é€‰é€‰é¡¹ (1ä¸ªç«¯ç‚¹)
â”‚   â””â”€â”€ mappings.py          # åç§°æ˜ å°„ (3ä¸ªç«¯ç‚¹: GET + POST + reload)
```

## âœ… ä»»åŠ¡æ¸…å•

### Phase 1: å‡†å¤‡å·¥ä½œ
- [ ] 1.1 åˆ›å»º `backend/routers/stats/` ç›®å½•
- [ ] 1.2 å¤‡ä»½åŸå§‹ `stats.py` ä¸º `stats.py.backup`

### Phase 2: æå–å…¬å…±å·¥å…·å‡½æ•°
- [ ] 2.1 åˆ›å»º `backend/routers/stats/__init__.py`
- [ ] 2.2 æå– `get_server_config_from_id()` è¾…åŠ©å‡½æ•°åˆ° `__init__.py`
- [ ] 2.3 å¯¼å‡ºæ‰€æœ‰å¿…è¦çš„ä¾èµ–

### Phase 3: æ‹†åˆ†å„æ¨¡å— (æœ€å°å¯æ‰§è¡Œå•å…ƒ)

#### 3.1 æ‹†åˆ† overview.py
- [ ] 3.1.1 åˆ›å»º `backend/routers/stats/overview.py` æ–‡ä»¶
- [ ] 3.1.2 æ·»åŠ å¯¼å…¥è¯­å¥ (database, services, utilsç­‰)
- [ ] 3.1.3 åˆ›å»º APIRouter å®ä¾‹: `router = APIRouter(prefix="/api", tags=["stats-overview"])`
- [ ] 3.1.4 å¤åˆ¶ `get_overview()` å‡½æ•° (è¡Œ40-106)
- [ ] 3.1.5 æµ‹è¯•ç«¯ç‚¹: `GET /api/overview`

#### 3.2 æ‹†åˆ† trend.py
- [ ] 3.2.1 åˆ›å»º `backend/routers/stats/trend.py` æ–‡ä»¶
- [ ] 3.2.2 æ·»åŠ å¯¼å…¥è¯­å¥
- [ ] 3.2.3 åˆ›å»º APIRouter: `router = APIRouter(prefix="/api", tags=["stats-trend"])`
- [ ] 3.2.4 å¤åˆ¶ `get_trend()` å‡½æ•° (è¡Œ109-158)
- [ ] 3.2.5 å¤åˆ¶ `get_hourly_stats()` å‡½æ•° (è¡Œ425-473)
- [ ] 3.2.6 æµ‹è¯•ç«¯ç‚¹: `GET /api/trend`, `GET /api/hourly`

#### 3.3 æ‹†åˆ† users.py
- [ ] 3.3.1 åˆ›å»º `backend/routers/stats/users.py` æ–‡ä»¶
- [ ] 3.3.2 æ·»åŠ å¯¼å…¥è¯­å¥
- [ ] 3.3.3 åˆ›å»º APIRouter: `router = APIRouter(prefix="/api", tags=["stats-users"])`
- [ ] 3.3.4 å¤åˆ¶ `get_user_stats()` å‡½æ•° (è¡Œ161-217)
- [ ] 3.3.5 æµ‹è¯•ç«¯ç‚¹: `GET /api/users`

#### 3.4 æ‹†åˆ† content.py
- [ ] 3.4.1 åˆ›å»º `backend/routers/stats/content.py` æ–‡ä»¶
- [ ] 3.4.2 æ·»åŠ å¯¼å…¥è¯­å¥
- [ ] 3.4.3 åˆ›å»º APIRouter: `router = APIRouter(prefix="/api", tags=["stats-content"])`
- [ ] 3.4.4 å¤åˆ¶ `get_client_stats()` å‡½æ•° (è¡Œ220-291)
- [ ] 3.4.5 å¤åˆ¶ `get_device_stats()` å‡½æ•° (è¡Œ294-371)
- [ ] 3.4.6 å¤åˆ¶ `get_playback_methods()` å‡½æ•° (è¡Œ374-422)
- [ ] 3.4.7 æµ‹è¯•ç«¯ç‚¹: `GET /api/clients`, `GET /api/devices`, `GET /api/playback-methods`

#### 3.5 æ‹†åˆ† history.py
- [ ] 3.5.1 åˆ›å»º `backend/routers/stats/history.py` æ–‡ä»¶
- [ ] 3.5.2 æ·»åŠ å¯¼å…¥è¯­å¥
- [ ] 3.5.3 åˆ›å»º APIRouter: `router = APIRouter(prefix="/api", tags=["stats-history"])`
- [ ] 3.5.4 å¤åˆ¶ `get_now_playing()` å‡½æ•° (è¡Œ476-541)
- [ ] 3.5.5 å¤åˆ¶ `get_recent_plays()` å‡½æ•° (è¡Œ544-687) - **æœ€å¤æ‚çš„å‡½æ•°**
- [ ] 3.5.6 æµ‹è¯•ç«¯ç‚¹: `GET /api/now-playing`, `GET /api/recent`

#### 3.6 æ‹†åˆ† favorites.py
- [ ] 3.6.1 åˆ›å»º `backend/routers/stats/favorites.py` æ–‡ä»¶
- [ ] 3.6.2 æ·»åŠ å¯¼å…¥è¯­å¥ (åŒ…æ‹¬ httpx)
- [ ] 3.6.3 åˆ›å»º APIRouter: `router = APIRouter(prefix="/api", tags=["stats-favorites"])`
- [ ] 3.6.4 å¤åˆ¶å†…éƒ¨è¾…åŠ©å‡½æ•°: `normalize_user_id()`, `to_dashed_guid()` (è¡Œ831-838)
- [ ] 3.6.5 å¤åˆ¶ `get_favorites()` å‡½æ•° (è¡Œ801-977) - **æœ€é•¿çš„å‡½æ•°**
- [ ] 3.6.6 æµ‹è¯•ç«¯ç‚¹: `GET /api/favorites`

#### 3.7 æ‹†åˆ† filters.py
- [ ] 3.7.1 åˆ›å»º `backend/routers/stats/filters.py` æ–‡ä»¶
- [ ] 3.7.2 æ·»åŠ å¯¼å…¥è¯­å¥
- [ ] 3.7.3 åˆ›å»º APIRouter: `router = APIRouter(prefix="/api", tags=["stats-filters"])`
- [ ] 3.7.4 å¤åˆ¶ `get_filter_options()` å‡½æ•° (è¡Œ690-775)
- [ ] 3.7.5 æµ‹è¯•ç«¯ç‚¹: `GET /api/filter-options`

#### 3.8 æ‹†åˆ† mappings.py
- [ ] 3.8.1 åˆ›å»º `backend/routers/stats/mappings.py` æ–‡ä»¶
- [ ] 3.8.2 æ·»åŠ å¯¼å…¥è¯­å¥
- [ ] 3.8.3 åˆ›å»º APIRouter: `router = APIRouter(prefix="/api", tags=["stats-mappings"])`
- [ ] 3.8.4 å¤åˆ¶ `get_name_mappings()` å‡½æ•° (è¡Œ778-781)
- [ ] 3.8.5 å¤åˆ¶ `save_name_mappings()` å‡½æ•° (è¡Œ784-791)
- [ ] 3.8.6 å¤åˆ¶ `reload_name_mappings()` å‡½æ•° (è¡Œ794-798)
- [ ] 3.8.7 æµ‹è¯•ç«¯ç‚¹: `GET /api/name-mappings`, `POST /api/name-mappings`, `POST /api/name-mappings/reload`

### Phase 4: æ›´æ–° __init__.py å¯¼å‡ºæ‰€æœ‰è·¯ç”±
- [ ] 4.1 åœ¨ `backend/routers/stats/__init__.py` ä¸­å¯¼å…¥æ‰€æœ‰å­æ¨¡å—çš„ router
- [ ] 4.2 åˆ›å»ºä¸€ä¸ªå‡½æ•° `include_all_routers(app)` æˆ–ç›´æ¥å¯¼å‡ºè·¯ç”±åˆ—è¡¨

### Phase 5: æ›´æ–°ä¸»åº”ç”¨
- [ ] 5.1 ä¿®æ”¹ `backend/main.py`ï¼Œæ›´æ–°å¯¼å…¥è¯­å¥
- [ ] 5.2 å°†åŸæ¥çš„ `app.include_router(stats.router)` æ”¹ä¸ºåŒ…å«æ‰€æœ‰å­è·¯ç”±
- [ ] 5.3 ç¡®ä¿æ‰€æœ‰è·¯ç”±æ­£ç¡®æ³¨å†Œ

### Phase 6: æµ‹è¯•å’ŒéªŒè¯
- [ ] 6.1 å¯åŠ¨åº”ç”¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¯¼å…¥é”™è¯¯
- [ ] 6.2 æµ‹è¯•æ‰€æœ‰15ä¸ªAPIç«¯ç‚¹æ˜¯å¦æ­£å¸¸å“åº”
- [ ] 6.3 éªŒè¯æ‰€æœ‰ç«¯ç‚¹çš„åŠŸèƒ½ä¸åŸæ¥ä¸€è‡´
- [ ] 6.4 æ£€æŸ¥å‰ç«¯æ˜¯å¦æ­£å¸¸å·¥ä½œ

### Phase 7: æ¸…ç†å’Œæ–‡æ¡£æ›´æ–°
- [ ] 7.1 åˆ é™¤åŸå§‹ `backend/routers/stats.py` æ–‡ä»¶
- [ ] 7.2 ä¿ç•™å¤‡ä»½æ–‡ä»¶ `backend/routers/stats.py.backup` (å¯é€‰)
- [ ] 7.3 æ›´æ–° `DEVELOPMENT.md` ä¸­çš„ç›®å½•ç»“æ„è¯´æ˜
- [ ] 7.4 æ›´æ–°ç‰ˆæœ¬å· (frontend-vue ç›¸å…³æ–‡ä»¶)
- [ ] 7.5 æ›´æ–° `CHANGELOG.md`

### Phase 8: Docker æ„å»ºå’Œå‘å¸ƒ
- [ ] 8.1 ä½¿ç”¨ docker-compose é‡æ–°æ„å»ºé•œåƒ
- [ ] 8.2 ä½¿ç”¨æœ€æ–°é•œåƒé‡å¯å®¹å™¨è¿›è¡Œæœ¬åœ°æµ‹è¯•
- [ ] 8.3 éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸åï¼Œæ„å»ºæ­£å¼ç‰ˆæœ¬
- [ ] 8.4 æ¨é€æ–°ç‰ˆæœ¬åˆ° Docker Hub (qc0624/emby-stats)

---

## ğŸ“Š æ‹†åˆ†ç»Ÿè®¡

| æ¨¡å— | ç«¯ç‚¹æ•° | é¢„ä¼°è¡Œæ•° | å¤æ‚åº¦ |
|------|-------|---------|--------|
| overview.py | 1 | ~70 | ä½ |
| trend.py | 2 | ~110 | ä½ |
| users.py | 1 | ~60 | ä½ |
| content.py | 3 | ~210 | ä¸­ |
| history.py | 2 | ~220 | é«˜ |
| favorites.py | 1 | ~180 | é«˜ |
| filters.py | 1 | ~90 | ä¸­ |
| mappings.py | 3 | ~35 | ä½ |
| **æ€»è®¡** | **15** | **~975** | - |

---

## ğŸ”„ æ‰§è¡ŒçŠ¶æ€

å½“å‰çŠ¶æ€: **å·²å®Œæˆ âœ…**

å®Œæˆæ—¶é—´: 2025-12-17

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ¯å®Œæˆä¸€ä¸ªå°ä»»åŠ¡ç«‹å³æ‰“å‹¾ âœ…**ï¼Œæ–¹ä¾¿ä¸­æ–­åç»§ç»­
2. **æ¯ä¸ªæ¨¡å—æ‹†åˆ†åç«‹å³æµ‹è¯•**ï¼Œä¸è¦ç­‰åˆ°å…¨éƒ¨å®Œæˆ
3. **ä¿æŒåŸå§‹ä»£ç é€»è¾‘ä¸å˜**ï¼Œåªæ˜¯æ‹†åˆ†æ–‡ä»¶ç»“æ„
4. **ç¡®ä¿æ‰€æœ‰å¯¼å…¥è¯­å¥å®Œæ•´**ï¼Œé¿å…é—æ¼ä¾èµ–
5. **æµ‹è¯•æ—¶æ³¨æ„å‰ç«¯è°ƒç”¨çš„APIè·¯å¾„ä¸å˜**
6. **å¦‚æœé‡åˆ°é—®é¢˜ï¼Œç«‹å³è®°å½•åœ¨æœ¬æ–‡ä»¶æœ«å°¾**

---

## âš ï¸ é—®é¢˜è®°å½•

### é—®é¢˜ 1: å¾ªç¯å¯¼å…¥é”™è¯¯
**é—®é¢˜æè¿°**: æ‹†åˆ†åå‡ºç°å¾ªç¯å¯¼å…¥ï¼š`__init__.py` å¯¼å…¥å­æ¨¡å—ï¼Œå­æ¨¡å—åˆä» `__init__.py` å¯¼å…¥è¾…åŠ©å‡½æ•°
**è§£å†³æ–¹æ¡ˆ**: åˆ›å»ºç‹¬ç«‹çš„ `helpers.py` æ¨¡å—å­˜æ”¾ `get_server_config_from_id` å‡½æ•°ï¼Œæ‰€æœ‰å­æ¨¡å—ä» `helpers` å¯¼å…¥
**çŠ¶æ€**: å·²è§£å†³ âœ…

### é—®é¢˜ 2: Docker é•œåƒæ„å»ºä¸éƒ¨ç½²
**é—®é¢˜æè¿°**: ä¿®æ”¹ä»£ç åæœªæ­£ç¡®æ„å»ºé•œåƒå¹¶é‡å¯å®¹å™¨
**è§£å†³æ–¹æ¡ˆ**: æ­£ç¡®ä½¿ç”¨ `docker build -t qc0624/emby-stats:latest .` æ„å»ºé•œåƒï¼Œç„¶å `docker compose down && docker compose up -d` é‡å¯
**çŠ¶æ€**: å·²è§£å†³ âœ…

---

## âœ… å®Œæˆæ—¥å¿—

### 2025-12-17 å®Œæ•´é‡æ„è®°å½•

#### âœ… Phase 1: å‡†å¤‡å·¥ä½œ
- åˆ›å»º `backend/routers/stats/` ç›®å½•
- å¤‡ä»½åŸå§‹ `stats.py` ä¸º `stats.py.backup`

#### âœ… Phase 2: æå–å…¬å…±å·¥å…·å‡½æ•°
- åˆ›å»º `backend/routers/stats/helpers.py`ï¼ˆè§£å†³å¾ªç¯å¯¼å…¥ï¼‰
- å®ç° `get_server_config_from_id()` è¾…åŠ©å‡½æ•°

#### âœ… Phase 3: æ‹†åˆ†8ä¸ªå­æ¨¡å—
- `overview.py` - æ€»è§ˆç»Ÿè®¡ (1ä¸ªç«¯ç‚¹)
- `trend.py` - è¶‹åŠ¿ç»Ÿè®¡ (2ä¸ªç«¯ç‚¹: trend + hourly)
- `users.py` - ç”¨æˆ·ç»Ÿè®¡ (1ä¸ªç«¯ç‚¹)
- `content.py` - å†…å®¹ç»Ÿè®¡ (3ä¸ªç«¯ç‚¹: clients + devices + playback-methods)
- `history.py` - å†å²è®°å½• (2ä¸ªç«¯ç‚¹: recent + now-playing)
- `favorites.py` - æ”¶è—ç»Ÿè®¡ (1ä¸ªç«¯ç‚¹)
- `filters.py` - ç­›é€‰é€‰é¡¹ (1ä¸ªç«¯ç‚¹)
- `mappings.py` - åç§°æ˜ å°„ (3ä¸ªç«¯ç‚¹)

#### âœ… Phase 4: æ›´æ–°è·¯ç”±ç³»ç»Ÿ
- æ›´æ–° `backend/routers/stats/__init__.py` å¯¼å‡ºæ‰€æœ‰è·¯ç”±
- æ›´æ–° `backend/routers/__init__.py` å¯¼å…¥ stats_routers
- æ›´æ–° `backend/main.py` æ³¨å†Œæ‰€æœ‰å­è·¯ç”±

#### âœ… Phase 5: æµ‹è¯•ä¸éƒ¨ç½²
- Pythonè¯­æ³•æ£€æŸ¥ï¼šå…¨éƒ¨é€šè¿‡
- Dockeré•œåƒæ„å»ºï¼šæˆåŠŸ
- å®¹å™¨å¯åŠ¨æµ‹è¯•ï¼šæˆåŠŸï¼Œæ— é”™è¯¯
- æ‰€æœ‰15ä¸ªAPIç«¯ç‚¹ä¿æŒå…¼å®¹

#### âœ… Phase 6: æ¸…ç†ä¸æ–‡æ¡£
- åˆ é™¤åŸå§‹ `stats.py` æ–‡ä»¶
- ä¿ç•™ `stats.py.backup` å¤‡ä»½æ–‡ä»¶
- æ›´æ–° `REFACTOR_TASK_LIST.md` æ ‡è®°å®Œæˆ

### æˆæœæ€»ç»“

**ä»£ç è´¨é‡æå‡**:
- åŸå§‹æ–‡ä»¶ï¼š979è¡Œï¼Œ15ä¸ªç«¯ç‚¹
- æ‹†åˆ†åï¼š9ä¸ªæ–‡ä»¶ï¼ˆ8ä¸ªæ¨¡å— + 1ä¸ªhelpersï¼‰ï¼Œæ¯ä¸ª50-250è¡Œ
- ä»£ç å¯ç»´æŠ¤æ€§ï¼šâ­â­â­â­â­

**æ¨¡å—ç»“æ„æ¸…æ™°**:
```
backend/routers/stats/
â”œâ”€â”€ __init__.py       (27è¡Œ - è·¯ç”±å¯¼å‡º)
â”œâ”€â”€ helpers.py        (18è¡Œ - è¾…åŠ©å‡½æ•°)
â”œâ”€â”€ overview.py       (91è¡Œ - æ€»è§ˆ)
â”œâ”€â”€ trend.py         (123è¡Œ - è¶‹åŠ¿)
â”œâ”€â”€ users.py         (79è¡Œ - ç”¨æˆ·)
â”œâ”€â”€ content.py       (236è¡Œ - å†…å®¹)
â”œâ”€â”€ history.py       (260è¡Œ - å†å²)
â”œâ”€â”€ favorites.py     (214è¡Œ - æ”¶è—)
â”œâ”€â”€ filters.py       (106è¡Œ - ç­›é€‰)
â””â”€â”€ mappings.py      (31è¡Œ - æ˜ å°„)
```

**å‘åå…¼å®¹**:
- âœ… æ‰€æœ‰APIç«¯ç‚¹è·¯å¾„ä¸å˜
- âœ… æ‰€æœ‰APIå“åº”æ ¼å¼ä¸å˜
- âœ… å‰ç«¯æ— éœ€ä»»ä½•ä¿®æ”¹
- âœ… Dockeré•œåƒæ­£å¸¸è¿è¡Œ
